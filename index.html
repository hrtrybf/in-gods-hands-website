<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lawn Care Estimate (Subtract Building SF)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 40px auto;
      text-align: center;
    }
    input, button, select {
      margin: 10px;
      padding: 8px;
      width: 70%;
      max-width: 300px;
    }
    #status, #result {
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h2>Lawn Care Estimate (Subtract House Square Footage)</h2>

<!-- Address Input -->
<label for="userAddress">Enter Address:</label><br>
<input type="text" id="userAddress" placeholder="123 Main St, Cleveland OH">
<button onclick="fetchArea()">Get Lawn Size</button>

<p id="status"></p>
<p id="lawnSizeResult"></p>

<!-- Service Dropdown -->
<select id="services">
  <option value="">-- Select a Service --</option>
  <option value="mowing">Lawn Mowing & Maintenance (Starting at $20)</option>
  <!-- Add other services if needed -->
</select>

<button onclick="calculateCost()">Calculate Cost</button>
<p id="result"></p>

<script>
  const KOORDINATES_API_KEY = "YOUR_KOORDINATES_API_KEY"; // Demo only, keep secret in production
  const KOORDINATES_LAYER = "99099";

  let cachedLawnSqFt = 0; // Will hold (lot sq ft - building sq ft)

  /**
   * 1) Geocode the user’s address (via OpenStreetMap)
   * 2) Query Koordinates for the parcel
   * 3) Subtract building sq ft from total lot area
   * 4) Store the result in cachedLawnSqFt
   */
  async function fetchArea() {
    const address = document.getElementById("userAddress").value.trim();
    const statusEl = document.getElementById("status");
    const sizeEl = document.getElementById("lawnSizeResult");
    statusEl.innerText = "";
    sizeEl.innerText = "";
    cachedLawnSqFt = 0;

    if (!address) {
      statusEl.innerText = "Please enter a valid address.";
      return;
    }

    statusEl.innerText = "Geocoding address ...";

    try {
      // Geocode with Nominatim
      const geoRes = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`
      );
      const geoData = await geoRes.json();
      if (!geoData || !geoData.length) {
        throw new Error("Address not found via Nominatim.");
      }

      // Use the first match
      const lat = parseFloat(geoData[0].lat);
      const lon = parseFloat(geoData[0].lon);

      statusEl.innerText = "Address found. Querying Koordinates...";

      // Koordinates vector query
      const koordUrl = `https://koordinates.com/services/query/v1/vector.json?` +
        `key=${KOORDINATES_API_KEY}&layer=${KOORDINATES_LAYER}` +
        `&x=${lon}&y=${lat}&max_results=3&radius=10000` +
        `&geometry=true&with_field_names=true`;

      const kRes = await fetch(koordUrl);
      const kData = await kRes.json();

      if (!kData || !kData.vectorQuery || !kData.vectorQuery.layers) {
        throw new Error("No data from Koordinates.");
      }

      const layer = kData.vectorQuery.layers[KOORDINATES_LAYER];
      if (!layer || !layer.features || layer.features.length === 0) {
        throw new Error("No parcel features found near that location.");
      }

      // For simplicity, pick the FIRST feature (you might want to find the best match)
      const feature = layer.features[0];
      const props = feature.properties;

      // 2 main fields: ACRES (total lot area) and BLDGSF (building sq ft)
      const acresVal = parseFloat(props.ACRES || 0);  // e.g. 0.4039
      const buildingSF = parseFloat(props.BLDGSF || 0); // e.g. 510
      // If field names differ, adjust above.

      // Convert acres to total sq ft
      const totalLotSqFt = acresVal * 43560;
      // Subtract building footprint
      cachedLawnSqFt = totalLotSqFt - buildingSF;

      if (cachedLawnSqFt < 0) {
        cachedLawnSqFt = 0; // Just in case data is off
      }

      statusEl.innerText = "";
      sizeEl.innerText =
        `Total Lot: ${Math.round(totalLotSqFt)} sq ft — Building: ${buildingSF} sq ft → Lawn: ${Math.round(cachedLawnSqFt)} sq ft`;
    } catch (err) {
      statusEl.innerText = "Error fetching parcel data.";
      console.error(err);
    }
  }

  /**
   * Calculate cost using your formulas, focusing on lawn area
   */
  function calculateCost() {
    const resultEl = document.getElementById("result");
    resultEl.innerText = "";
    if (!cachedLawnSqFt) {
      resultEl.innerText = "Please fetch a valid lawn size first.";
      return;
    }

    const svc = document.getElementById("services").value;
    if (!svc) {
      resultEl.innerText = "Please select a service.";
      return;
    }

    let price = 0;

    if (svc === "mowing") {
      // Price_mowing = max(20, 0.02 * lawnSqFt)
      price = Math.max(20, 0.02 * cachedLawnSqFt);
    }

    // ... If you want more services, add them here ...
    // e.g., aeration, mulching, etc.

    resultEl.innerText = `Estimated Cost: $${price.toFixed(2)}`;
  }
</script>

</body>
</html>
